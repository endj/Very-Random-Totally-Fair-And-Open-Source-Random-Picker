<!DOCTYPE HTML>

<body>

  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <style>
      body {
        margin: 0;
        background-color: rgb(0, 0, 0, 0.8);
      }

      button {
        background: white;
        width: 35px;
        border-left: 1px solid black;
        border-bottom: 0px;
        border-top: 0px;
        border-right: 0px;
        cursor: pointer
      }

      button:hover {
        background-color: whitesmoke
      }

      button:active {
        box-shadow: inset 2px 2px 2px 2px #666;
      }

      .menu-button {
        padding: 7px;
        border-radius: 5px;
        width: auto;
      }

      input {
        padding: 7px;
        border-radius: 5px;
      }

      li {
        padding: 0 0 0 5px;
      }

      canvas {
        background-color: white;
        margin: auto;
      }

      .span {
        font-weight: 200;
      }

      .name {
        width: 200px;
        border-bottom: 1px solid black;
        display: flex;
        justify-content: space-between;
        background: whitesmoke;
      }

      .popup {
        position: absolute;
        width: 100%;
        height: 100%;
        background: rgba(255, 0, 0, 0.158);
        top: 0;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .result {
        width: 50%;
        max-height: 80%;
        background: #faf5ec;
        padding: 20px;
        border-radius: 10px;
      }

      #confettis {
        overflow: hidden;
        position: absolute;
        height: 100%;
        width: 100%;
        top: 0;
        left: 0;
      }

      .confetti {
        left: 50%;
        width: 16px;
        height: 16px;
        position: absolute;
        transform-origin: left top;
        animation: confetti 5s ease-in-out -2s infinite;
      }

      @keyframes confetti {
        0% {
          transform: rotateZ(15deg) rotateY(0deg) translate(0, 0);
        }

        25% {
          transform: rotateZ(5deg) rotateY(360deg) translate(-5vw, 20vh);
        }

        50% {
          transform: rotateZ(15deg) rotateY(720deg) translate(5vw, 60vh);
        }

        75% {
          transform: rotateZ(5deg) rotateY(1080deg) translate(-10vw, 80vh);
        }

        100% {
          transform: rotateZ(15deg) rotateY(1440deg) translate(10vw, 110vh);
        }
      }

      .confetti:nth-child(1) {
        left: 10%;
        animation-delay: 0;
        background-color: #fc0120;
      }

      .confetti:nth-child(2) {
        left: 20%;
        animation-delay: -5s;
        background-color: #8257e6;
      }

      .confetti:nth-child(3) {
        left: 30%;
        animation-delay: -3s;
        background-color: #ffbf4d;
      }

      .confetti:nth-child(4) {
        left: 40%;
        animation-delay: -2.5s;
        background-color: #fe5d7a;
      }

      .confetti:nth-child(5) {
        left: 50%;
        animation-delay: -4s;
        background-color: #45ec9c;
      }

      .confetti:nth-child(6) {
        left: 60%;
        animation-delay: -6s;
        background-color: #f6e327;
      }

      .confetti:nth-child(7) {
        left: 70%;
        animation-delay: -1.5s;
        background-color: #f769ce;
      }

      .confetti:nth-child(8) {
        left: 80%;
        animation-delay: -2s;
        background-color: #007de7;
      }

      .confetti:nth-child(9) {
        left: 90%;
        animation-delay: -3.5s;
        background-color: #63b4fc;
      }

      .confetti:nth-child(10) {
        left: 100%;
        animation-delay: -2.5s;
        background-color: #f9c4ea;
      }
    </style>
  </head>
  <div id="result"></div>
  <div style="display: flex; flex-direction: column;">
    <div>
      <input placeholder="Add names" autofocus id="in"></input>
      <button class="menu-button" onclick="addName()">+</button>
      <button class="menu-button" onclick="savePreset()">Save as preset</button>
      <button class="menu-button" onclick="loadPreset()">Load preset</button>
      <button class="menu-button" id="init-btn" onclick="init()">"Spin" the wheel</button>
      <ul id="users"></ul>
    </div>
    <canvas id="canvas" hidden=true></canvas>
  </div>


  <script>
    const SOUND = {
      applause: new Audio("a.wav")
    }
    let CONFIG = {
      maxRender: 1000,
      baseVelocity: 8,
      randomVelocity: 2,
      renderNames: true,
      userListRenderLimit: 25
    }

    let running = false;
    const W = innerWidth
    const H = innerHeight
    const positionWidth = 2;
    const positionHeight = 2;
    const get = id => document.getElementById(id);
    const create = type => document.createElement(type);
    const canvas = get('canvas');
    canvas.width = W
    canvas.height = H
    const context = canvas.getContext('2d', { alpha: false });
    context.font = '30px Arial';
    const clear = () => {
      context.fillStyle = 'white';
      context.fillRect(0, 0, canvas.width, canvas.height);
      context.strokeStyle = 'black'
      context.fillStyle = "black"
    };
    // clear();


    let userSet = new Set();
    const input = get('in');
    const users = get('users');

    input.addEventListener('keypress', e => {
      if (e.key == 'Enter') {
        if (e.shiftKey && !running) {
          init();
        } else {
          addName();
        }
      }
    });

    const savePreset = () => {
      try {
        if (userSet.size > 0) {
          localStorage.setItem("endj_randompicker", JSON.stringify([...userSet]))
        }
      } catch (e) {
        console.error(e)
      }
    }
    const loadPreset = () => {
      try {

        let users = localStorage.getItem("endj_randompicker")
        if (users) {
          userSet = new Set(JSON.parse(users));
        }
      } catch (e) {
        console.error(e)
      }

      render();
    }


    const render = () => {
      get('users').innerHTML = '';
      let renderedUsers = Math.min(CONFIG.userListRenderLimit, userSet.size);
      for (user of userSet) {
        addUserToList(user);
        if (renderedUsers-- === 0) {
          addUserListContinuation(userSet.size - CONFIG.userListRenderLimit)
          break
        }
      }
    };

    const remove = name => {
      userSet.delete(name);
      render();
    };


    const addUserToList = name => {

      let item = create('li');
      item.classList.add('name');
      item.innerHTML = `<span>${name}</span><button onclick="remove('${name}')">-</button>`;
      users.appendChild(item);
    };


    const addUserListContinuation = (more) => {
      let item = create('li')
      item.classList.add('name');
      item.innerHTML = `<span>and ${more} more...</span>`
      users.appendChild(item)
    }

    const addName = () => {
      input.value && userSet.add(input.value);
      input.value = '';
      render();
    };


    const randpos = () => Math.floor(Math.random() * W - positionWidth);
    const coinflip = () => Math.random() > 0.5;

    let positions = [];
    let target = { x: W / 2, y: H / 2 };

    const onStart = () => {
      running = true;
      get('init-btn').disabled = true;
      get("users").hidden = true;
      canvas.hidden = false;
      get("canvas").requestFullscreen()
    };


    const onEnd = () => {
      running = false;
      get('init-btn').disabled = false;
      document.exitFullscreen()
    };

    const init = () => {
      if (userSet.size === 0) {
        return
      }
      onStart();


      if (userSet.size > 1000) {
        CONFIG.renderNames = false;
      }

      positions = [...userSet].map(name => {
        const dx = Math.random();
        const dy = Math.random();
        return {
          name: name,
          x: Math.floor(W / 2 + (coinflip() ? -Math.random() * W / 8 : Math.random() * W / 8)),
          y: Math.floor(H / 2 + (coinflip() ? -Math.random() * H / 8 : Math.random() * H / 8)),
          dx: coinflip() ? dx : -dx,
          dy: coinflip() ? dy : -dy,
          velocity: CONFIG.baseVelocity + Math.random() * CONFIG.randomVelocity
        };
      });
      target = {
        x: Math.floor(100 + Math.random() * (W - 200)),
        y: Math.floor(100 + Math.random() * (H - 200))
      };
      tick();
    };

    const drawPoint = (point) => {
      context.fillRect(point.x, point.y, positionWidth, positionHeight);
      CONFIG.renderNames && context.strokeText(point.name, point.x + 10, point.y + 10);
    };

    const drawTarget = (target) => {
      const orig = context.lineWidth
      context.lineWidth = 10;
      context.strokeStyle = "red"
      context.beginPath();
      context.moveTo(target.x - 10, target.y - 10);
      context.lineTo(target.x + 10, target.y + 10);
      context.stroke();
      context.beginPath();
      context.moveTo(target.x - 10, target.y + 10);
      context.lineTo(target.x + 10, target.y - 10);
      context.stroke();
      context.lineWidth = orig
    };

    const computeFinalScore = () => {
      const result = [];
      positions.forEach(p => {
        const [x, y] = [p.x + positionWidth / 2, p.y + positionHeight / 2];
        const distance = Math.sqrt(Math.pow((x - target.x), 2) + Math.pow((y - target.y), 2));
        result.push({ dist: distance, pos: p });
      });
      return result.sort((a, b) => a.dist - b.dist);
    };

    const drawLines = scores => {
      scores.forEach(score => {
        const [x, y] = [score.pos.x + positionWidth / 2, score.pos.y + positionHeight / 2];
        context.beginPath()
        context.moveTo(x, y)
        context.lineTo(target.x, target.y)
        context.stroke()
      })
    }

    const closePopup = () => {
      get('result').innerHTML = '';
      get("users").hidden = false;
    };

    const resultPopup = (scores) => {
      const popup = create('div');
      const wrapper = create('div');
      popup.id = 'popup';
      wrapper.classList.add('result');
      popup.classList.add('popup');


      const medals = ["ðŸ¥‰", "ðŸ¥ˆ", "ðŸ¥‡"]
      wrapper.innerHTML += `<h1>Congrats ${scores[0].pos.name}</h1>`
      scores.forEach(score => {
        wrapper.innerHTML += `<div><span>${medals.pop()}</span> <span>${score.pos.name} -> ${score.dist}</span></div>`;
      });
      popup.appendChild(wrapper);
      wrapper.innerHTML += `<div id="confettis">
                                <div class="confetti"></div>
                                <div class="confetti"></div>
                                <div class="confetti"></div>
                                <div class="confetti"></div>
                                <div class="confetti"></div>
                                <div class="confetti"></div>
                                <div class="confetti"></div>
                                <div class="confetti"></div>
                                <div class="confetti"></div>
                            </div>`

      get('result').appendChild(popup);
    };

    const updatePoint = (p) => {
      if (p.x > W) {
        p.dx = p.dx > 0 ? -p.dx : p.dx
      }
      if (p.x < 0) {
        p.dx = p.dx > 0 ? p.dx : -p.dx
      }
      if (p.y > H) {
        p.dy = p.dy > 0 ? -p.dy : p.dy
      }
      if (p.y < 0) {
        p.dy = p.dy > 0 ? p.dy : -p.dy
      }
      p.x = p.x + (p.dx * p.velocity) % W;
      p.y = p.y + (p.dy * p.velocity) % H;
      if (p.velocity !== 0) {
        p.velocity = Math.abs(p.velocity - 0.01) > 0.1 ? p.velocity - 0.01 : 0;
      }
    }

    const tick = () => {
      clear();
      let done = true;


      var i = 0, len = positions.length;
      while (i < len) {
        updatePoint(positions[i])
        i++;
      }

      i = 0
      while (i < len) {
        const point = positions[i];
        drawPoint(point)
        done &= point.velocity === 0;
        i++;
      }

      drawTarget(target);
      if (!done) {
        window.requestAnimationFrame(tick);
      } else {
        onEnd();
        const scores = computeFinalScore();
        const top3 = scores.slice(0, 3)
        drawLines(top3)
        resultPopup(top3);
        SOUND.applause.play()
        setTimeout("closePopup()", 6000);
      }
    };
  </script>
</body>